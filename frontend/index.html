<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behavioral Pattern Discovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ============================================================================
   CSS Variables & Base Styles
   ============================================================================ */
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-card: rgba(30, 41, 59, 0.8);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent-primary: #3b82f6;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    --border-color: rgba(148, 163, 184, 0.2);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    --radius: 12px;
    --radius-sm: 8px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

/* ============================================================================
   Layout
   ============================================================================ */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.header {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 24px;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 24px;
}

.header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.project-selector {
    display: flex;
    align-items: center;
    gap: 12px;
}

.main-content {
    flex: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
    width: 100%;
}

/* ============================================================================
   Section Tabs
   ============================================================================ */
.section-tabs {
    display: flex;
    gap: 4px;
    background: var(--bg-secondary);
    padding: 4px;
    border-radius: var(--radius);
    margin-bottom: 24px;
}

.section-tab {
    flex: 1;
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.section-tab:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.section-tab.active {
    background: var(--accent-primary);
    color: white;
}

.section-tab .tab-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
}

.section-tab.active .tab-number {
    background: rgba(255, 255, 255, 0.3);
}

/* ============================================================================
   Cards & Sections
   ============================================================================ */
.section-content {
    display: none;
}

.section-content.active {
    display: block;
}

.card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.card-header h2 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-header h3 {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-secondary);
}

/* ============================================================================
   Form Elements
   ============================================================================ */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: var(--accent-primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: #2563eb;
}

.btn-success {
    background: var(--accent-success);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background: #059669;
}

.btn-warning {
    background: var(--accent-warning);
    color: white;
}

.btn-danger {
    background: var(--accent-danger);
    color: white;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-secondary:hover:not(:disabled) {
    background: #475569;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}

.select {
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.9rem;
    min-width: 200px;
}

.select:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.input {
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.controls-vertical {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
}

.control-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.control-row label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.control-row input[type="number"] {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    color: var(--text-primary);
}

/* ============================================================================
   Status Messages
   ============================================================================ */
.status-message {
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    margin-top: 12px;
}

.status-message.info {
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #93c5fd;
}

.status-message.success {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
}

.status-message.error {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
}

.status-message.warning {
    background: rgba(245, 158, 11, 0.2);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #fcd34d;
}

/* ============================================================================
   Pipeline Visualization (Section 2)
   ============================================================================ */
.pipeline-container {
    margin-bottom: 24px;
}

.pipeline-steps {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 16px 0;
}

.pipeline-step {
    flex: 1;
    min-width: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.pipeline-step::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -4px;
    width: 8px;
    height: 2px;
    background: var(--border-color);
}

.pipeline-step:last-child::after {
    display: none;
}

.step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.pipeline-step.pending .step-indicator {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
    color: var(--text-muted);
}

.pipeline-step.in-progress .step-indicator {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
    animation: pulse 1.5s ease-in-out infinite;
}

.pipeline-step.completed .step-indicator {
    background: var(--accent-success);
    border-color: var(--accent-success);
    color: white;
}

.pipeline-step.failed .step-indicator {
    background: var(--accent-danger);
    border-color: var(--accent-danger);
    color: white;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.step-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-align: center;
    max-width: 80px;
}

.pipeline-step.in-progress .step-label,
.pipeline-step.completed .step-label {
    color: var(--text-primary);
}

/* ============================================================================
   R2 Status Grid (Section 2)
   ============================================================================ */
.r2-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.r2-file-item {
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.r2-file-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.r2-file-item.exists .r2-file-icon {
    background: rgba(16, 185, 129, 0.2);
    color: var(--accent-success);
}

.r2-file-item.missing .r2-file-icon {
    background: rgba(100, 116, 139, 0.2);
    color: var(--text-muted);
}

.r2-file-info {
    flex: 1;
    min-width: 0;
}

.r2-file-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.r2-file-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* ============================================================================
   Starting Point Selector (Section 2)
   ============================================================================ */
.starting-point-selector {
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 16px;
}

.starting-point-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
}

.starting-point-option {
    padding: 12px 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s ease;
}

.starting-point-option:hover:not(.disabled) {
    border-color: var(--accent-primary);
}

.starting-point-option.selected {
    border-color: var(--accent-primary);
    background: rgba(59, 130, 246, 0.1);
}

.starting-point-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.starting-point-option .option-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.starting-point-option .option-desc {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

.starting-point-option .option-prereq {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 8px;
}

.starting-point-option.disabled .option-prereq {
    color: var(--accent-danger);
}

/* ============================================================================
   Logs Container
   ============================================================================ */
.logs-container {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 16px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.8rem;
    line-height: 1.8;
}

.log-line {
    padding: 2px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.log-line:last-child {
    border-bottom: none;
}

.log-timestamp {
    color: var(--text-muted);
    margin-right: 8px;
}

.log-section {
    color: #a78bfa;
    margin-right: 8px;
}

.log-line.log-info { color: var(--text-secondary); }
.log-line.log-success { color: var(--accent-success); }
.log-line.log-warning { color: var(--accent-warning); }
.log-line.log-error { color: var(--accent-danger); }

.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

/* ============================================================================
   Engineer Table (Section 1)
   ============================================================================ */
.engineer-table-container {
    overflow-x: auto;
    margin-top: 16px;
}

.engineer-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.engineer-table th,
.engineer-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
}

.engineer-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-secondary);
}

/* Column width hints */
.engineer-table td:nth-child(2) { max-width: 180px; overflow: hidden; text-overflow: ellipsis; } /* Engineer ID */
.engineer-table td:nth-child(3) { width: 70px; text-align: right; } /* Activities */
.engineer-table td:nth-child(4) { width: 80px; } /* Split */
.engineer-table td:nth-child(5) { width: 60px; text-align: center; } /* Internal */
.engineer-table td:nth-child(6) { width: 50px; text-align: center; } /* Bot */
.engineer-table td:nth-child(7) { max-width: 150px; overflow: hidden; text-overflow: ellipsis; } /* Sources */
.engineer-table td:nth-child(8) { max-width: 200px; overflow: hidden; text-overflow: ellipsis; } /* Projects */

.engineer-table th[data-sort] {
    cursor: pointer;
    user-select: none;
}

.engineer-table th[data-sort]:hover {
    color: var(--text-primary);
}

.engineer-table th.sorted {
    color: var(--accent-primary);
}

.engineer-table th.sorted::after {
    margin-left: 4px;
}

.engineer-table th.sorted.asc::after {
    content: ' \25B2';
}

.engineer-table th.sorted.desc::after {
    content: ' \25BC';
}

.engineer-table tbody tr:hover {
    background: rgba(59, 130, 246, 0.1);
}

.engineer-table .checkbox-cell {
    width: 40px;
    text-align: center;
}

.split-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.split-badge.train {
    background: rgba(16, 185, 129, 0.2);
    color: var(--accent-success);
}

.split-badge.validation {
    background: rgba(59, 130, 246, 0.2);
    color: var(--accent-primary);
}

.split-badge.bot {
    background: rgba(239, 68, 68, 0.2);
    color: var(--accent-danger);
}

/* ============================================================================
   Pattern List (Section 3)
   ============================================================================ */
.pattern-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.pattern-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s ease;
}

.pattern-item:hover {
    background: var(--bg-secondary);
}

.pattern-item.selected {
    border-left: 3px solid var(--accent-primary);
}

.pattern-level {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.pattern-level.top { background: rgba(52, 211, 153, 0.2); color: #34d399; }
.pattern-level.mid { background: rgba(147, 197, 253, 0.2); color: #93c5fd; }
.pattern-level.bottom { background: rgba(252, 211, 77, 0.2); color: #fcd34d; }
.pattern-level.unified { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }

.pattern-name {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.pattern-status {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ============================================================================
   Scoring Results (Section 4)
   ============================================================================ */
.scores-display {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 16px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.85rem;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.report-display {
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    padding: 20px;
    line-height: 1.8;
}

/* ============================================================================
   File Upload
   ============================================================================ */
.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-sm);
    padding: 32px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--accent-primary);
    background: rgba(59, 130, 246, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--accent-primary);
    background: rgba(59, 130, 246, 0.1);
}

.file-upload-icon {
    font-size: 2rem;
    margin-bottom: 12px;
    color: var(--text-muted);
}

.file-upload-text {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.file-upload-text strong {
    color: var(--accent-primary);
}

.file-input {
    display: none;
}

.selected-file {
    margin-top: 12px;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    color: var(--text-primary);
}

/* ============================================================================
   Progress Bar
   ============================================================================ */
.progress-bar-container {
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    height: 8px;
    overflow: hidden;
    margin-top: 12px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
    border-radius: var(--radius-sm);
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
}

/* ============================================================================
   Error Banner
   ============================================================================ */
.error-banner {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(185, 28, 28, 0.2) 100%);
    border: 2px solid var(--accent-danger);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    animation: errorBannerAppear 0.3s ease-out;
}

@keyframes errorBannerAppear {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.error-banner-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.error-banner-icon {
    width: 40px;
    height: 40px;
    background: var(--accent-danger);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
    flex-shrink: 0;
}

.error-banner-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent-danger);
}

.error-banner-step {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 2px;
}

.error-banner-message {
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin: 12px 0;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.85rem;
    color: #fca5a5;
    max-height: 150px;
    overflow-y: auto;
    word-break: break-word;
}

.error-banner-suggestion {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 16px;
}

.error-banner-suggestion strong {
    color: var(--text-primary);
}

.error-banner-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.error-banner-completed {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.error-banner-completed span {
    color: var(--accent-success);
    font-weight: 500;
}

/* ============================================================================
   Utilities
   ============================================================================ */
.hidden { display: none !important; }
.mt-4 { margin-top: 16px; }
.mb-4 { margin-bottom: 16px; }
.flex { display: flex; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-4 { gap: 16px; }
.text-muted { color: var(--text-muted); }
.text-sm { font-size: 0.85rem; }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>Behavioral Pattern Discovery</h1>
                <div class="project-selector">
                    <select id="project-select" class="select">
                        <option value="">Select a project...</option>
                    </select>
                    <button id="btn-refresh-projects" class="btn btn-secondary btn-sm">Refresh</button>
                    <input type="text" id="new-project-name" class="input" placeholder="New project name..." style="width: 180px;">
                    <button id="btn-create-project" class="btn btn-primary btn-sm">Create</button>
                    <button id="btn-delete-project" class="btn btn-danger btn-sm hidden">Delete</button>
                    <button id="btn-create-variant" class="btn btn-secondary btn-sm hidden">Create Variant</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Section Tabs -->
            <div class="section-tabs">
                <button class="section-tab active" data-section="data">
                    <span class="tab-number">1</span>
                    Data Collection
                </button>
                <button class="section-tab" data-section="processing">
                    <span class="tab-number">2</span>
                    Processing Pipeline
                </button>
                <button class="section-tab" data-section="naming">
                    <span class="tab-number">3</span>
                    Pattern Naming
                </button>
                <button class="section-tab" data-section="scoring">
                    <span class="tab-number">4</span>
                    Individual Scoring
                </button>
            </div>

            <!-- ================================================================
                 SECTION 1: Data Collection (Segment A)
                 ================================================================ -->
            <div id="section-data" class="section-content active">
                <!-- Data Source -->
                <div class="card">
                    <div class="card-header">
                        <h2>Data Source</h2>
                    </div>

                    <div class="file-upload-area" id="upload-area">
                        <div class="file-upload-icon">üìÅ</div>
                        <div class="file-upload-text">
                            <strong>Click to upload</strong> or drag and drop<br>
                            NDJSON folder (zip) or individual files
                        </div>
                        <input type="file" id="ndjson-file" class="file-input" accept=".zip,.ndjson">
                    </div>
                    <div id="selected-file-display" class="selected-file hidden"></div>

                    <div class="controls mt-4">
                        <button id="btn-fetch-ndjson" class="btn btn-primary" disabled>Load Data</button>
                        <span id="data-status" class="text-muted text-sm"></span>
                    </div>
                    <div id="data-status-message" class="status-message hidden"></div>
                </div>

                <!-- Engineer Summary -->
                <div class="card">
                    <div class="card-header">
                        <h2>Engineers</h2>
                        <div class="controls">
                            <button id="btn-refresh-engineer-summary" class="btn btn-secondary btn-sm" disabled>Refresh</button>
                        </div>
                    </div>

                    <div class="controls mb-4">
                        <button id="btn-set-train" class="btn btn-success btn-sm" disabled>Set Train</button>
                        <button id="btn-set-validation" class="btn btn-primary btn-sm" disabled>Set Validation</button>
                        <button id="btn-merge-engineers" class="btn btn-secondary btn-sm" disabled>Merge Selected</button>
                        <button id="btn-remove-selected" class="btn btn-danger btn-sm" disabled>Remove Selected</button>
                    </div>

                    <div class="engineer-table-container">
                        <table class="engineer-table" id="engineer-summary-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" id="select-all-engineers">
                                    </th>
                                    <th data-sort="engineer_id">Engineer ID</th>
                                    <th data-sort="activity_count">Activities</th>
                                    <th data-sort="split">Split</th>
                                    <th data-sort="is_internal">Internal</th>
                                    <th data-sort="is_bot">Bot</th>
                                    <th data-sort="sources">Sources</th>
                                    <th data-sort="projects">Projects</th>
                                </tr>
                            </thead>
                            <tbody id="engineer-table-body">
                                <tr>
                                    <td colspan="8" class="text-muted" style="text-align: center; padding: 32px;">
                                        No data loaded. Upload NDJSON files to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 1 Logs -->
                <div class="card">
                    <div class="logs-header">
                        <h3>Logs</h3>
                        <button id="btn-clear-data-logs" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                    <div id="data-logs" class="logs-container"></div>
                </div>
            </div>

            <!-- ================================================================
                 SECTION 2: Processing Pipeline (Segment B)
                 ================================================================ -->
            <div id="section-processing" class="section-content">
                <!-- Error Banner (hidden by default) -->
                <div id="pipeline-error-banner" class="error-banner hidden">
                    <div class="error-banner-header">
                        <div class="error-banner-icon">!</div>
                        <div>
                            <div class="error-banner-title">Pipeline Failed</div>
                            <div class="error-banner-step" id="error-step-info">Step B.X failed</div>
                        </div>
                    </div>
                    <div class="error-banner-message" id="error-message-content">
                        Error details will appear here...
                    </div>
                    <div class="error-banner-suggestion">
                        <strong>Suggested action:</strong> <span id="error-suggestion">Check the logs for more details.</span>
                    </div>
                    <div class="error-banner-actions">
                        <button id="btn-retry-pipeline" class="btn btn-primary">Retry from Failed Step</button>
                        <button id="btn-retry-full" class="btn btn-secondary">Restart Full Pipeline</button>
                        <button id="btn-dismiss-error" class="btn btn-secondary btn-sm">Dismiss</button>
                    </div>
                    <div class="error-banner-completed hidden" id="error-completed-steps">
                        Steps completed before failure: <span id="completed-steps-list">None</span>
                    </div>
                </div>

                <!-- Pipeline Visualization -->
                <div class="card">
                    <div class="card-header">
                        <h2>Pipeline Status</h2>
                        <button id="btn-refresh-r2-status" class="btn btn-secondary btn-sm">Refresh Status</button>
                    </div>

                    <div class="pipeline-container">
                        <div class="pipeline-steps" id="pipeline-steps">
                            <div class="pipeline-step pending" data-step="B.1">
                                <div class="step-indicator">B1</div>
                                <div class="step-label">Stats</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.2">
                                <div class="step-indicator">B2</div>
                                <div class="step-label">Embed</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.3">
                                <div class="step-indicator">B3</div>
                                <div class="step-label">Normalize</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.4">
                                <div class="step-indicator">B4</div>
                                <div class="step-label">Prep</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.5">
                                <div class="step-indicator">B5</div>
                                <div class="step-label">Train</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.6">
                                <div class="step-indicator">B6</div>
                                <div class="step-label">Score</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.7">
                                <div class="step-indicator">B7</div>
                                <div class="step-label">Assign</div>
                            </div>
                            <div class="pipeline-step pending" data-step="B.8">
                                <div class="step-indicator">B8</div>
                                <div class="step-label">SHAP</div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Display -->
                    <div id="pipeline-progress" class="hidden">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-step">Preparing...</span>
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Starting Point Selector -->
                <div class="card">
                    <div class="card-header">
                        <h2>Run Pipeline</h2>
                    </div>

                    <div class="starting-point-selector">
                        <label class="text-sm text-muted">Select starting point:</label>
                        <div class="starting-point-options" id="starting-point-options">
                            <div class="starting-point-option selected" data-step="full">
                                <div class="option-title">Full Pipeline</div>
                                <div class="option-desc">Run all steps from the beginning</div>
                                <div class="option-prereq">Requires: activities.csv</div>
                            </div>
                            <div class="starting-point-option disabled" data-step="from_training">
                                <div class="option-title">From Training</div>
                                <div class="option-desc">Skip embedding, start at normalization</div>
                                <div class="option-prereq">Requires: embeddings, aux_features</div>
                            </div>
                            <div class="starting-point-option disabled" data-step="from_scoring">
                                <div class="option-title">From Batch Scoring</div>
                                <div class="option-desc">Re-score with existing model</div>
                                <div class="option-prereq">Requires: checkpoint, train_input</div>
                            </div>
                            <div class="starting-point-option disabled" data-step="shap_only">
                                <div class="option-title">SHAP Only</div>
                                <div class="option-desc">Re-run SHAP analysis</div>
                                <div class="option-prereq">Requires: checkpoint, activations</div>
                            </div>
                        </div>
                    </div>

                    <div class="controls-vertical">
                        <div class="control-row">
                            <label for="max-messages-per-engineer">Max messages per engineer:</label>
                            <input type="number" id="max-messages-per-engineer" placeholder="No limit" min="1" style="width: 100px;">
                        </div>
                        <div class="control-row">
                            <button id="btn-start-pipeline" class="btn btn-primary" disabled>Start Processing</button>
                            <button id="btn-stop-pipeline" class="btn btn-danger hidden">Stop</button>
                        </div>
                    </div>
                    <div id="processing-status-message" class="status-message hidden"></div>
                </div>

                <!-- R2 File Status -->
                <div class="card">
                    <div class="card-header">
                        <h2>R2 Storage Status</h2>
                    </div>
                    <div class="r2-status-grid" id="r2-status-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Section 2 Logs -->
                <div class="card">
                    <div class="logs-header">
                        <h3>Processing Logs</h3>
                        <button id="btn-clear-processing-logs" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                    <div id="processing-logs" class="logs-container"></div>
                </div>
            </div>

            <!-- ================================================================
                 SECTION 3: Pattern Naming (Segment C)
                 ================================================================ -->
            <div id="section-naming" class="section-content">
                <!-- Naming Controls -->
                <div class="card">
                    <div class="card-header">
                        <h2>Pattern Naming</h2>
                    </div>

                    <p class="text-muted mb-4">
                        Generate human-readable names and descriptions for discovered patterns using LLM analysis.
                    </p>

                    <div class="controls">
                        <button id="btn-name-patterns" class="btn btn-primary" disabled>Generate Names</button>
                        <button id="btn-refresh-patterns" class="btn btn-secondary" disabled>Refresh List</button>
                        <button id="btn-population-viewer" class="btn btn-secondary" disabled>Population Viewer</button>
                    </div>
                    <div id="naming-status-message" class="status-message hidden"></div>

                    <!-- Progress Display -->
                    <div id="naming-progress" class="hidden mt-4">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="naming-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="naming-progress-text">Naming patterns...</span>
                            <span id="naming-progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Pattern List -->
                <div class="card">
                    <div class="card-header">
                        <h2>Patterns</h2>
                        <div class="text-sm text-muted" id="pattern-count">0 patterns</div>
                    </div>

                    <div class="pattern-list" id="pattern-list">
                        <div class="text-muted" style="text-align: center; padding: 32px;">
                            No patterns available. Run processing pipeline first.
                        </div>
                    </div>
                </div>

                <!-- Section 3 Logs -->
                <div class="card">
                    <div class="logs-header">
                        <h3>Naming Logs</h3>
                        <button id="btn-clear-naming-logs" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                    <div id="naming-logs" class="logs-container"></div>
                </div>
            </div>

            <!-- ================================================================
                 SECTION 4: Individual Scoring (Segment D)
                 ================================================================ -->
            <div id="section-scoring" class="section-content">
                <!-- Engineer Selection -->
                <div class="card">
                    <div class="card-header">
                        <h2>Score Individual Engineer</h2>
                    </div>

                    <div class="controls mb-4">
                        <select id="scoring-engineer-select" class="select" disabled>
                            <option value="">Select an engineer...</option>
                        </select>
                        <button id="btn-refresh-scoring-engineers" class="btn btn-secondary btn-sm" disabled>Refresh</button>
                    </div>

                    <div class="controls">
                        <button id="btn-score-engineer" class="btn btn-primary" disabled>Score Engineer</button>
                        <button id="btn-generate-report" class="btn btn-success" disabled>Generate Report</button>
                        <button id="btn-view-report" class="btn btn-secondary" disabled>View Full Report</button>
                    </div>
                    <div id="scoring-status-message" class="status-message hidden"></div>
                </div>

                <!-- Scores Display -->
                <div class="card" id="scores-card" style="display: none;">
                    <div class="card-header">
                        <h2>Scores</h2>
                        <button id="btn-download-scores" class="btn btn-secondary btn-sm">Download JSON</button>
                    </div>
                    <pre class="scores-display" id="scores-display"></pre>
                </div>

                <!-- Report Display -->
                <div class="card" id="report-card" style="display: none;">
                    <div class="card-header">
                        <h2>Report Summary</h2>
                        <button id="btn-download-report" class="btn btn-secondary btn-sm">Download</button>
                    </div>
                    <div class="report-display" id="report-display"></div>
                </div>

                <!-- Section 4 Logs -->
                <div class="card">
                    <div class="logs-header">
                        <h3>Scoring Logs</h3>
                        <button id="btn-clear-scoring-logs" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                    <div id="scoring-logs" class="logs-container"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
// ============================================================================
// Configuration & State
// ============================================================================
const API_BASE = window.location.pathname.startsWith('/bpd')
    ? `${window.location.origin}/bpd`
    : window.location.origin;

// Application State
const state = {
    projectId: localStorage.getItem('bpd_project_id') || null,
    projectName: localStorage.getItem('bpd_project_name') || null,
    currentSection: 'data',
    selectedStartingPoint: 'full',
    selectedEngineerId: null,
    r2Status: {},
    hetznerStatus: {},
    pipelineRunning: false,
    failedStep: null,
    ws: null,
    engineerData: [],
    patternData: [],
};

// R2 file configuration
const R2_FILES = {
    embeddings: { label: 'Embeddings', icon: 'üìä' },
    aux_features: { label: 'Aux Features', icon: 'üìà' },
    normalized_embeddings: { label: 'Normalized', icon: 'üìê' },
    train_input: { label: 'Train Input', icon: 'üì¶' },
    message_database: { label: 'Message DB', icon: 'üí¨' },
    checkpoint: { label: 'Checkpoint', icon: 'üéØ' },
    activations: { label: 'Activations', icon: '‚ö°' },
};

// Pipeline steps configuration
const PIPELINE_STEPS = [
    { id: 'B.1', label: 'Stats', outputs: ['aux_features'] },
    { id: 'B.2', label: 'Embed', outputs: ['embeddings'] },
    { id: 'B.3', label: 'Normalize', outputs: ['normalized_embeddings'] },
    { id: 'B.4', label: 'Prep', outputs: ['train_input', 'message_database'] },
    { id: 'B.5', label: 'Train', outputs: ['checkpoint'] },
    { id: 'B.6', label: 'Score', outputs: ['activations'] },
    { id: 'B.7', label: 'Assign', outputs: [] },
    { id: 'B.8', label: 'SHAP', outputs: [] },
];

// Starting point prerequisites
const STARTING_POINTS = {
    'full': { r2: [], hetzner: ['activities.csv'] },
    'from_training': { r2: ['embeddings', 'aux_features'], hetzner: ['activities.csv'] },
    'from_scoring': { r2: ['checkpoint', 'train_input', 'message_database'], hetzner: [] },
    'shap_only': { r2: ['checkpoint', 'activations'], hetzner: [] },
};

// ============================================================================
// API Helpers
// ============================================================================
function getProjectApiBase() {
    if (!state.projectId) {
        throw new Error('No project selected');
    }
    return `${API_BASE}/api/projects/${state.projectId}`;
}

async function apiGet(endpoint) {
    const response = await fetch(`${getProjectApiBase()}${endpoint}`);
    if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Request failed' }));
        throw new Error(error.detail || `HTTP ${response.status}`);
    }
    return response.json();
}

async function apiPost(endpoint, data = {}) {
    const response = await fetch(`${getProjectApiBase()}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
    });
    if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Request failed' }));
        throw new Error(error.detail || `HTTP ${response.status}`);
    }
    return response.json();
}

// ============================================================================
// UI Helpers
// ============================================================================
function $(selector) {
    return document.querySelector(selector);
}

function $$(selector) {
    return document.querySelectorAll(selector);
}

function showStatus(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.textContent = message;
    el.className = `status-message ${type}`;
    el.classList.remove('hidden');
}

function hideStatus(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.classList.add('hidden');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatDate(isoString) {
    return new Date(isoString).toLocaleString();
}

// ============================================================================
// Section Navigation
// ============================================================================
function switchSection(sectionId) {
    state.currentSection = sectionId;

    // Update tabs
    $$('.section-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.section === sectionId);
    });

    // Update content
    $$('.section-content').forEach(content => {
        content.classList.toggle('active', content.id === `section-${sectionId}`);
    });

    // Refresh section data
    if (state.projectId) {
        switch (sectionId) {
            case 'data':
                refreshEngineerSummary();
                break;
            case 'processing':
                refreshR2Status();
                break;
            case 'naming':
                refreshPatternList();
                break;
            case 'scoring':
                refreshScoringEngineers();
                break;
        }
    }
}

// ============================================================================
// Logging
// ============================================================================
function appendLog(section, message, level = 'info') {
    const logContainers = {
        data: 'data-logs',
        processing: 'processing-logs',
        naming: 'naming-logs',
        scoring: 'scoring-logs',
    };

    const containerId = logContainers[section] || 'processing-logs';
    const container = document.getElementById(containerId);
    if (!container) return;

    const timestamp = new Date().toLocaleTimeString();
    const logLine = document.createElement('div');
    logLine.className = `log-line log-${level}`;
    logLine.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${escapeHtml(message)}`;

    container.appendChild(logLine);
    container.scrollTop = container.scrollHeight;
}

function clearLogs(section) {
    const logContainers = {
        data: 'data-logs',
        processing: 'processing-logs',
        naming: 'naming-logs',
        scoring: 'scoring-logs',
    };

    const containerId = logContainers[section];
    const container = document.getElementById(containerId);
    if (container) container.innerHTML = '';
}

// ============================================================================
// WebSocket
// ============================================================================
function connectWebSocket() {
    if (!state.projectId) return;
    if (state.ws && state.ws.readyState === WebSocket.OPEN) return;

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsPrefix = window.location.pathname.startsWith('/bpd') ? '/bpd' : '';
    const wsUrl = `${protocol}//${window.location.host}${wsPrefix}/ws/projects/${state.projectId}/events`;

    try {
        state.ws = new WebSocket(wsUrl);

        state.ws.onopen = () => {
            console.log('WebSocket connected');
        };

        state.ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            } catch (e) {
                console.error('Failed to parse WebSocket message:', e);
            }
        };

        state.ws.onclose = () => {
            console.log('WebSocket disconnected, reconnecting in 5s...');
            setTimeout(() => {
                if (state.projectId) connectWebSocket();
            }, 5000);
        };

        state.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    } catch (e) {
        console.error('Failed to create WebSocket:', e);
    }
}

function handleWebSocketMessage(data) {
    const eventType = data.type;
    const section = data.section || 'processing';

    // Map section to log container
    const sectionMap = {
        embedding: 'processing',
        preprocessing: 'processing',
        training: 'processing',
        scoring: 'processing',
        shap: 'processing',
        naming: 'naming',
        general: 'processing',
    };

    const logSection = sectionMap[section] || 'processing';
    let level = 'info';
    let message = '';

    switch (eventType) {
        case 'job_status':
            message = data.message || 'Status update';
            break;

        case 'job_progress':
            const pct = Math.round((data.progress || 0) * 100);
            message = data.message || `Progress: ${pct}%`;

            // Update pipeline progress UI
            if (data.step) {
                updatePipelineProgress(data.step, data.progress, data.step_name);
            }
            break;

        case 'job_epoch':
            const metrics = data.metrics || {};
            const metricsStr = Object.entries(metrics)
                .slice(0, 4)
                .map(([k, v]) => `${k}=${typeof v === 'number' ? v.toFixed(4) : v}`)
                .join(', ');
            message = `Epoch ${data.epoch}: ${metricsStr}`;
            break;

        case 'job_completed':
            message = data.message || 'Completed';
            level = 'success';
            state.pipelineRunning = false;
            refreshR2Status();
            updatePipelineUI();
            break;

        case 'job_failed':
            message = `ERROR: ${data.error}`;
            level = 'error';
            state.pipelineRunning = false;
            updatePipelineUI();

            // Show prominent error banner
            showPipelineError({
                step: data.failed_step || data.step,
                stepName: data.failed_step_name || data.step_name,
                error: data.error,
                stepsCompleted: data.steps_completed || [],
            });
            break;

        default:
            return;
    }

    appendLog(logSection, message, level);
}

function updatePipelineProgress(stepId, progress, stepName) {
    // Update step indicators
    const steps = $$('.pipeline-step');
    let foundCurrent = false;

    steps.forEach(step => {
        const stepDataId = step.dataset.step;

        if (stepDataId === stepId) {
            step.className = 'pipeline-step in-progress';
            foundCurrent = true;
        } else if (!foundCurrent) {
            step.className = 'pipeline-step completed';
        } else {
            step.className = 'pipeline-step pending';
        }
    });

    // Update progress bar
    const progressBar = $('#progress-bar');
    const progressStep = $('#progress-step');
    const progressPercent = $('#progress-percent');
    const progressContainer = $('#pipeline-progress');

    if (progressContainer) {
        progressContainer.classList.remove('hidden');
    }

    if (progressBar) {
        progressBar.style.width = `${Math.round(progress * 100)}%`;
    }

    if (progressStep) {
        progressStep.textContent = stepName || stepId;
    }

    if (progressPercent) {
        progressPercent.textContent = `${Math.round(progress * 100)}%`;
    }
}

// ============================================================================
// Project Management
// ============================================================================
async function loadProjects() {
    const select = $('#project-select');

    try {
        const response = await fetch(`${API_BASE}/api/projects`);
        if (!response.ok) throw new Error('Failed to fetch projects');

        const projects = await response.json();

        // Separate root projects and variants
        const rootProjects = projects.filter(p => !p.parent_id);
        const variantsByParent = {};
        projects.filter(p => p.parent_id).forEach(v => {
            if (!variantsByParent[v.parent_id]) variantsByParent[v.parent_id] = [];
            variantsByParent[v.parent_id].push(v);
        });

        select.innerHTML = '<option value="">Select a project...</option>';

        // Render root projects with their variants nested below
        rootProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = `${project.name} (${project.status || 'new'})`;
            option.dataset.name = project.name;
            option.dataset.isRoot = 'true';
            select.appendChild(option);

            // Add variants as indented options
            const variants = variantsByParent[project.id] || [];
            variants.forEach(variant => {
                const varOption = document.createElement('option');
                varOption.value = variant.id;
                varOption.textContent = `  \u2514\u2500 ${variant.name} (${variant.status || 'new'})`;
                varOption.dataset.name = variant.name;
                varOption.dataset.isRoot = 'false';
                varOption.dataset.parentId = project.id;
                select.appendChild(varOption);
            });
        });

        // Restore previous selection
        if (state.projectId) {
            const exists = projects.some(p => p.id === state.projectId);
            if (exists) {
                select.value = state.projectId;
            } else {
                clearProjectSelection();
            }
        }
    } catch (error) {
        console.error('Failed to load projects:', error);
    }
}

async function createProject() {
    const nameInput = $('#new-project-name');
    const name = nameInput.value.trim();

    if (!name) {
        alert('Please enter a project name');
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/api/projects`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name }),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create project');
        }

        const project = await response.json();
        nameInput.value = '';

        await loadProjects();
        $('#project-select').value = project.id;
        await selectProject(project.id, name);

    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function selectProject(projectId, projectName) {
    if (!projectId) {
        clearProjectSelection();
        return;
    }

    state.projectId = projectId;
    const selectedOption = $('#project-select').selectedOptions[0];
    state.projectName = projectName || selectedOption?.dataset.name || projectId;
    state.isRootProject = selectedOption?.dataset.isRoot === 'true';
    state.parentId = selectedOption?.dataset.parentId || null;

    localStorage.setItem('bpd_project_id', state.projectId);
    localStorage.setItem('bpd_project_name', state.projectName);

    // Show delete button
    $('#btn-delete-project').classList.remove('hidden');

    // Show create variant button only for root projects
    if (state.isRootProject) {
        $('#btn-create-variant').classList.remove('hidden');
    } else {
        $('#btn-create-variant').classList.add('hidden');
    }

    // Connect WebSocket
    if (state.ws) {
        state.ws.close();
        state.ws = null;
    }
    connectWebSocket();

    // Enable UI and refresh data
    enableProjectUI();
    await refreshCurrentSection();
}

function clearProjectSelection() {
    state.projectId = null;
    state.projectName = null;
    state.isRootProject = null;
    state.parentId = null;
    localStorage.removeItem('bpd_project_id');
    localStorage.removeItem('bpd_project_name');

    $('#project-select').value = '';
    $('#btn-delete-project').classList.add('hidden');
    $('#btn-create-variant').classList.add('hidden');

    disableProjectUI();
}

async function deleteProject() {
    if (!state.projectId) return;

    const confirmed = confirm(`Delete project "${state.projectName}"?\n\nThis will permanently delete all data and results.`);
    if (!confirmed) return;

    try {
        const response = await fetch(`${API_BASE}/api/projects/${state.projectId}`, {
            method: 'DELETE',
        });

        const result = await response.json();

        // Handle deletion blocked by variants borrowing files
        if (response.status === 409 && result.error === 'deletion_blocked') {
            const borrowedFiles = result.borrowed_files || [];
            const fileList = borrowedFiles.map(bf =>
                `  - ${bf.variant_name}: ${bf.file_key}`
            ).join('\n');

            alert(`Cannot delete project: variants still borrow files.\n\nBorrowed files:\n${fileList}\n\nPlease delete the variants first, or run pipeline steps on them so they own their own copies.`);
            return;
        }

        if (!response.ok) {
            throw new Error(result.detail || 'Failed to delete project');
        }

        // Show detached variants if any
        if (result.detached_variants && result.detached_variants.length > 0) {
            console.log(`Detached ${result.detached_variants.length} variants that now own all their files`);
        }

        clearProjectSelection();
        await loadProjects();

    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// ============================================================================
// Variant Management (Phase 5)
// ============================================================================
function showCreateVariantDialog() {
    if (!state.projectId || !state.isRootProject) {
        alert('Please select a root project to create a variant');
        return;
    }

    const startingPoint = prompt(
        `Create variant of "${state.projectName}"\n\n` +
        `Enter starting point:\n` +
        `  B.5 - From Training (inherits embeddings)\n` +
        `  B.6 - From Batch Scoring (inherits checkpoint)\n` +
        `  B.8 - From SHAP (inherits activations)\n\n` +
        `Enter step (e.g., B.5):`,
        'B.6'
    );

    if (!startingPoint) return;

    const validSteps = ['B.5', 'B.6', 'B.8'];
    if (!validSteps.includes(startingPoint.toUpperCase())) {
        alert(`Invalid starting point. Please use one of: ${validSteps.join(', ')}`);
        return;
    }

    const variantName = prompt(
        `Enter name for the variant (or leave blank for default):`,
        ''
    );

    createVariant(startingPoint.toUpperCase(), variantName || null);
}

async function createVariant(startingStep, variantName) {
    try {
        const body = { starting_step: startingStep };
        if (variantName) body.name = variantName;

        const response = await fetch(`${API_BASE}/api/projects/${state.projectId}/variants`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create variant');
        }

        const variant = await response.json();
        await loadProjects();

        // Select the new variant
        $('#project-select').value = variant.id;
        await selectProject(variant.id, variant.name);

        alert(`Variant created: ${variant.name}`);

    } catch (error) {
        alert(`Error creating variant: ${error.message}`);
    }
}

function enableProjectUI() {
    // Section 1: Data
    $('#btn-fetch-ndjson').disabled = false;
    $('#btn-refresh-engineer-summary').disabled = false;

    // Section 2: Processing
    $('#btn-refresh-r2-status').disabled = false;

    // Section 3: Naming
    $('#btn-refresh-patterns').disabled = false;

    // Section 4: Scoring
    $('#btn-refresh-scoring-engineers').disabled = false;
}

function disableProjectUI() {
    // Section 1: Data
    $('#btn-fetch-ndjson').disabled = true;
    $('#btn-refresh-engineer-summary').disabled = true;
    $('#btn-set-train').disabled = true;
    $('#btn-set-validation').disabled = true;
    $('#btn-merge-engineers').disabled = true;
    $('#btn-remove-selected').disabled = true;

    // Section 2: Processing
    $('#btn-start-pipeline').disabled = true;
    $('#btn-refresh-r2-status').disabled = true;

    // Section 3: Naming
    $('#btn-name-patterns').disabled = true;
    $('#btn-refresh-patterns').disabled = true;
    $('#btn-population-viewer').disabled = true;

    // Section 4: Scoring
    $('#scoring-engineer-select').disabled = true;
    $('#btn-refresh-scoring-engineers').disabled = true;
    $('#btn-score-engineer').disabled = true;
    $('#btn-generate-report').disabled = true;
    $('#btn-view-report').disabled = true;
}

async function refreshCurrentSection() {
    switch (state.currentSection) {
        case 'data':
            await refreshEngineerSummary();
            break;
        case 'processing':
            await refreshR2Status();
            break;
        case 'naming':
            await refreshPatternList();
            break;
        case 'scoring':
            await refreshScoringEngineers();
            break;
    }
}

// ============================================================================
// Section 1: Data Collection
// ============================================================================
async function fetchNDJSON() {
    const fileInput = $('#ndjson-file');
    const file = fileInput.files[0];

    if (!file) {
        showStatus('data-status-message', 'Please select a file to upload', 'error');
        return;
    }

    const btn = $('#btn-fetch-ndjson');
    btn.disabled = true;
    showStatus('data-status-message', 'Uploading and processing data...', 'info');
    appendLog('data', 'Starting data upload...');

    try {
        // Upload file
        const formData = new FormData();
        formData.append('file', file);

        const uploadResponse = await fetch(`${getProjectApiBase()}/data/upload/ndjson`, {
            method: 'POST',
            body: formData,
        });

        if (!uploadResponse.ok) {
            const error = await uploadResponse.json();
            throw new Error(error.detail || 'Upload failed');
        }

        appendLog('data', 'File uploaded, processing...', 'info');

        // Trigger NDJSON processing (no input_path - backend uses uploaded file automatically)
        const processResponse = await fetch(`${getProjectApiBase()}/data/fetch/ndjson`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
        });

        if (!processResponse.ok) {
            const error = await processResponse.json();
            throw new Error(error.detail || 'Processing failed');
        }

        showStatus('data-status-message', 'Data loaded successfully!', 'success');
        appendLog('data', 'Data processing complete', 'success');

        // Refresh engineer list
        await refreshEngineerSummary();

    } catch (error) {
        showStatus('data-status-message', `Error: ${error.message}`, 'error');
        appendLog('data', `Error: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
    }
}

async function refreshEngineerSummary() {
    if (!state.projectId) return;

    try {
        const data = await apiGet('/data/engineers');
        state.engineerData = data.engineers || [];

        renderEngineerTable(state.engineerData);
        updateEngineerSelectionButtons();

    } catch (error) {
        console.error('Failed to refresh engineers:', error);
        renderEngineerTable([]);
    }
}

// Engineer table sorting state
let engineerSortColumn = 'engineer_id';
let engineerSortAsc = true;

function sortEngineers(engineers, column, asc) {
    return [...engineers].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        // Handle arrays (sources)
        if (Array.isArray(valA)) valA = valA.join(', ');
        if (Array.isArray(valB)) valB = valB.join(', ');

        // Handle nulls/undefined
        if (valA == null) valA = '';
        if (valB == null) valB = '';

        // Handle booleans
        if (typeof valA === 'boolean') valA = valA ? 1 : 0;
        if (typeof valB === 'boolean') valB = valB ? 1 : 0;

        // Handle numbers
        if (typeof valA === 'number' && typeof valB === 'number') {
            return asc ? valA - valB : valB - valA;
        }

        // String comparison (case-insensitive)
        const strA = String(valA);
        const strB = String(valB);
        const cmp = strA.localeCompare(strB, undefined, { sensitivity: 'base' });
        return asc ? cmp : -cmp;
    });
}

function updateSortIndicators() {
    $$('.engineer-table th[data-sort]').forEach(th => {
        th.classList.remove('sorted', 'asc', 'desc');
        if (th.dataset.sort === engineerSortColumn) {
            th.classList.add('sorted', engineerSortAsc ? 'asc' : 'desc');
        }
    });
}

function renderEngineerTable(engineers) {
    const tbody = $('#engineer-table-body');

    if (engineers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-muted" style="text-align: center; padding: 32px;">
                    No data loaded. Upload NDJSON files to get started.
                </td>
            </tr>
        `;
        return;
    }

    // Sort engineers
    const sorted = sortEngineers(engineers, engineerSortColumn, engineerSortAsc);

    tbody.innerHTML = sorted.map(eng => {
        // Projects come as comma-separated string from backend
        const projects = eng.projects ? eng.projects.split(',').filter(p => p.trim()).join(', ') : '-';
        return `
        <tr data-engineer-id="${escapeHtml(eng.engineer_id)}">
            <td class="checkbox-cell">
                <input type="checkbox" class="engineer-checkbox" value="${escapeHtml(eng.engineer_id)}">
            </td>
            <td>${escapeHtml(eng.engineer_id)}</td>
            <td>${eng.activity_count || 0}</td>
            <td>
                <span class="split-badge ${eng.split || 'train'}">${eng.split || 'train'}</span>
            </td>
            <td>${eng.is_internal === true ? 'Yes' : eng.is_internal === false ? 'No' : '-'}</td>
            <td>${eng.is_bot ? 'Yes' : 'No'}</td>
            <td>${(eng.sources || []).join(', ') || '-'}</td>
            <td>${escapeHtml(projects)}</td>
        </tr>
    `}).join('');

    updateSortIndicators();
}

function updateEngineerSelectionButtons() {
    const checkboxes = $$('.engineer-checkbox:checked');
    const hasSelection = checkboxes.length > 0;

    $('#btn-set-train').disabled = !hasSelection;
    $('#btn-set-validation').disabled = !hasSelection;
    $('#btn-remove-selected').disabled = !hasSelection;
    $('#btn-merge-engineers').disabled = checkboxes.length < 2;
}

async function setEngineerSplit(split) {
    const selected = Array.from($$('.engineer-checkbox:checked')).map(cb => cb.value);
    if (selected.length === 0) return;

    try {
        await apiPost('/data/engineers/set-split', {
            engineer_ids: selected,
            split: split,
        });

        await refreshEngineerSummary();
        appendLog('data', `Set ${selected.length} engineers to ${split}`, 'success');

    } catch (error) {
        appendLog('data', `Error: ${error.message}`, 'error');
    }
}

async function removeSelectedEngineers() {
    const selected = Array.from($$('.engineer-checkbox:checked')).map(cb => cb.value);
    if (selected.length === 0) return;

    const confirmed = confirm(`Remove ${selected.length} engineer(s)?`);
    if (!confirmed) return;

    try {
        await apiPost('/data/engineers/remove', {
            engineer_ids: selected,
        });

        await refreshEngineerSummary();
        appendLog('data', `Removed ${selected.length} engineers`, 'success');

    } catch (error) {
        appendLog('data', `Error: ${error.message}`, 'error');
    }
}

async function mergeSelectedEngineers() {
    const selected = Array.from($$('.engineer-checkbox:checked')).map(cb => cb.value);
    if (selected.length < 2) return;

    const targetId = prompt(`Enter name for merged engineer (merging ${selected.length} engineers):\n\nSelected: ${selected.join(', ')}`, selected[0]);
    if (targetId === null) return;
    if (!targetId.trim()) {
        alert('Engineer name cannot be empty');
        return;
    }

    try {
        await apiPost('/data/engineers/merge', {
            source_ids: selected,
            target_id: targetId.trim(),
        });

        await refreshEngineerSummary();
        appendLog('data', `Merged ${selected.length} engineers into "${targetId.trim()}"`, 'success');

    } catch (error) {
        appendLog('data', `Error: ${error.message}`, 'error');
    }
}

// ============================================================================
// Section 2: Processing Pipeline
// ============================================================================
async function refreshR2Status() {
    if (!state.projectId) return;

    try {
        const status = await apiGet('/r2-status');
        state.r2Status = status.r2 || {};
        state.hetznerStatus = status.hetzner || {};

        renderR2Status(state.r2Status);
        updateStartingPointOptions();
        updatePipelineSteps();

    } catch (error) {
        console.error('Failed to refresh R2 status:', error);
        renderR2Status({});
    }
}

function renderR2Status(status) {
    const grid = $('#r2-status-grid');

    grid.innerHTML = Object.entries(R2_FILES).map(([key, config]) => {
        const fileStatus = status[key] || { exists: false };
        const existsClass = fileStatus.exists ? 'exists' : 'missing';
        const meta = fileStatus.exists
            ? `${formatBytes(fileStatus.size_bytes || 0)}`
            : 'Not available';

        return `
            <div class="r2-file-item ${existsClass}">
                <div class="r2-file-icon">${config.icon}</div>
                <div class="r2-file-info">
                    <div class="r2-file-name">${config.label}</div>
                    <div class="r2-file-meta">${meta}</div>
                </div>
            </div>
        `;
    }).join('');
}

function updateStartingPointOptions() {
    const options = $$('.starting-point-option');

    options.forEach(option => {
        const stepId = option.dataset.step;
        const prereqs = STARTING_POINTS[stepId];

        // Check R2 prerequisites
        const r2Met = prereqs.r2.every(file => state.r2Status[file]?.exists);

        // Check Hetzner prerequisites
        const hetznerMet = prereqs.hetzner.every(file => {
            // Map frontend file names to backend keys
            const keyMap = {
                'activities.csv': 'activities',
            };
            const key = keyMap[file] || file;
            return state.hetznerStatus[key]?.exists;
        });

        const isAvailable = r2Met && (prereqs.hetzner.length === 0 || hetznerMet);

        option.classList.toggle('disabled', !isAvailable);

        if (option.classList.contains('selected') && !isAvailable) {
            option.classList.remove('selected');
            // Select full pipeline as fallback
            $$('.starting-point-option[data-step="full"]')[0]?.classList.add('selected');
            state.selectedStartingPoint = 'full';
        }
    });

    // Enable/disable start button
    const hasProject = !!state.projectId;
    const notRunning = !state.pipelineRunning;
    $('#btn-start-pipeline').disabled = !hasProject || !notRunning;
}

function updatePipelineSteps() {
    const steps = $$('.pipeline-step');

    // Determine completed steps based on R2 status
    const stepR2Outputs = {
        'B.1': ['aux_features'],
        'B.2': ['embeddings'],
        'B.3': ['normalized_embeddings'],
        'B.4': ['train_input', 'message_database'],
        'B.5': ['checkpoint'],
        'B.6': ['activations'],
        'B.7': [],
        'B.8': [],
    };

    // Determine completed steps based on Hetzner status
    const stepHetznerOutputs = {
        'B.7': ['message_examples'],
        'B.8': ['hierarchical_weights'],
    };

    steps.forEach(step => {
        const stepId = step.dataset.step;
        const r2Outputs = stepR2Outputs[stepId] || [];
        const hetznerOutputs = stepHetznerOutputs[stepId] || [];

        // Step is completed if all its outputs exist (check R2 or Hetzner)
        let isCompleted = false;
        if (r2Outputs.length > 0) {
            isCompleted = r2Outputs.every(output => state.r2Status[output]?.exists);
        } else if (hetznerOutputs.length > 0) {
            isCompleted = hetznerOutputs.every(output => state.hetznerStatus[output]?.exists);
        }

        if (!state.pipelineRunning) {
            step.className = isCompleted ? 'pipeline-step completed' : 'pipeline-step pending';
        }
    });
}

function selectStartingPoint(stepId) {
    const option = $(`.starting-point-option[data-step="${stepId}"]`);
    if (!option || option.classList.contains('disabled')) return;

    $$('.starting-point-option').forEach(opt => opt.classList.remove('selected'));
    option.classList.add('selected');
    state.selectedStartingPoint = stepId;
}

async function startPipeline() {
    if (!state.projectId || state.pipelineRunning) return;

    const btn = $('#btn-start-pipeline');
    btn.disabled = true;
    state.pipelineRunning = true;

    // Hide any existing error banner
    hidePipelineError();

    // Reset all pipeline step indicators to pending
    $$('.pipeline-step').forEach(step => {
        step.className = 'pipeline-step pending';
    });

    showStatus('processing-status-message', 'Starting processing pipeline...', 'info');
    appendLog('processing', `Starting pipeline from ${state.selectedStartingPoint}...`);

    // Show progress UI
    $('#pipeline-progress').classList.remove('hidden');
    $('#btn-stop-pipeline').classList.remove('hidden');

    try {
        // Build config with optional message limit
        const maxMessages = $('#max-messages-per-engineer').value;
        const config = {};
        if (maxMessages && parseInt(maxMessages) > 0) {
            config.processing = {
                sampling: {
                    max_activities_per_engineer: parseInt(maxMessages)
                }
            };
        }

        await apiPost('/process', {
            starting_step: state.selectedStartingPoint,
            config: Object.keys(config).length > 0 ? config : null,
        });

        showStatus('processing-status-message', 'Pipeline started. Monitor progress below.', 'info');

    } catch (error) {
        showStatus('processing-status-message', `Error: ${error.message}`, 'error');
        appendLog('processing', `Error: ${error.message}`, 'error');
        state.pipelineRunning = false;
        updatePipelineUI();
    }
}

function updatePipelineUI() {
    $('#btn-start-pipeline').disabled = state.pipelineRunning;
    $('#btn-stop-pipeline').classList.toggle('hidden', !state.pipelineRunning);

    if (!state.pipelineRunning) {
        $('#pipeline-progress').classList.add('hidden');
    }
}

function showPipelineError(errorInfo) {
    const banner = $('#pipeline-error-banner');
    const stepInfo = $('#error-step-info');
    const messageContent = $('#error-message-content');
    const suggestion = $('#error-suggestion');
    const completedStepsDiv = $('#error-completed-steps');
    const completedStepsList = $('#completed-steps-list');

    // Store failed step for retry
    state.failedStep = errorInfo.step;

    // Populate step info
    if (errorInfo.step && errorInfo.stepName) {
        stepInfo.textContent = `Step ${errorInfo.step} (${errorInfo.stepName}) failed`;
    } else if (errorInfo.step) {
        stepInfo.textContent = `Step ${errorInfo.step} failed`;
    } else {
        stepInfo.textContent = 'Pipeline failed';
    }

    // Populate error message
    messageContent.textContent = errorInfo.error || 'Unknown error occurred';

    // Generate suggestion based on error type
    const errorText = (errorInfo.error || '').toLowerCase();
    let suggestionText = 'Check the logs above for more details and retry when ready.';

    if (errorText.includes('timeout') || errorText.includes('timed out')) {
        suggestionText = 'The operation timed out. This may be due to large data volume. Consider restarting or splitting the data.';
    } else if (errorText.includes('memory') || errorText.includes('oom')) {
        suggestionText = 'Ran out of memory. Consider processing with a smaller batch size or fewer engineers.';
    } else if (errorText.includes('r2') || errorText.includes('storage')) {
        suggestionText = 'Storage access failed. Check R2 credentials and connectivity, then retry.';
    } else if (errorText.includes('model') || errorText.includes('checkpoint')) {
        suggestionText = 'Model or checkpoint error. Verify the model files exist and are not corrupted.';
    } else if (errorText.includes('cuda') || errorText.includes('gpu')) {
        suggestionText = 'GPU error occurred. The GPU may be out of memory or unavailable. Retry may resolve this.';
    }

    suggestion.textContent = suggestionText;

    // Show completed steps if any
    if (errorInfo.stepsCompleted && errorInfo.stepsCompleted.length > 0) {
        completedStepsDiv.classList.remove('hidden');
        completedStepsList.textContent = errorInfo.stepsCompleted.join(', ');
    } else {
        completedStepsDiv.classList.add('hidden');
    }

    // Mark the failed step in the UI
    if (errorInfo.step) {
        const stepEl = $(`.pipeline-step[data-step="${errorInfo.step}"]`);
        if (stepEl) {
            stepEl.className = 'pipeline-step failed';
        }
    }

    // Show the banner
    banner.classList.remove('hidden');

    // Scroll to the banner
    banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hidePipelineError() {
    const banner = $('#pipeline-error-banner');
    banner.classList.add('hidden');
    state.failedStep = null;
}

async function retryFromFailedStep() {
    if (!state.failedStep) {
        // If no failed step recorded, just restart from the selected starting point
        hidePipelineError();
        await startPipeline();
        return;
    }

    hidePipelineError();

    // Set the starting point to the failed step
    const failedStep = state.failedStep;
    state.selectedStartingPoint = failedStep;

    // Update UI to show selected step
    $$('.starting-point-option').forEach(opt => opt.classList.remove('selected'));
    const targetOption = $(`.starting-point-option[data-step="${failedStep}"]`);
    if (targetOption && !targetOption.classList.contains('disabled')) {
        targetOption.classList.add('selected');
    }

    await startPipeline();
}

async function retryFullPipeline() {
    hidePipelineError();

    // Reset to full pipeline
    state.selectedStartingPoint = 'full';

    // Update UI
    $$('.starting-point-option').forEach(opt => opt.classList.remove('selected'));
    $(`.starting-point-option[data-step="full"]`)?.classList.add('selected');

    await startPipeline();
}

// ============================================================================
// Section 3: Pattern Naming
// ============================================================================
async function refreshPatternList() {
    if (!state.projectId) return;

    try {
        const data = await apiGet('/patterns');
        state.patternData = data.patterns || [];

        renderPatternList(state.patternData);
        updateNamingButtons();

    } catch (error) {
        console.error('Failed to refresh patterns:', error);
        renderPatternList([]);
    }
}

function renderPatternList(patterns) {
    const container = $('#pattern-list');
    const countEl = $('#pattern-count');

    countEl.textContent = `${patterns.length} patterns`;

    if (patterns.length === 0) {
        container.innerHTML = `
            <div class="text-muted" style="text-align: center; padding: 32px;">
                No patterns available. Run processing pipeline first.
            </div>
        `;
        return;
    }

    // Sort patterns: unified first, then top, mid, bottom
    const levelOrder = { 'unified': 0, 'top': 1, 'mid': 2, 'bottom': 3 };
    const sortedPatterns = [...patterns].sort((a, b) => {
        const levelA = extractLevel(a.level || a.id);
        const levelB = extractLevel(b.level || b.id);
        const orderDiff = (levelOrder[levelA] ?? 4) - (levelOrder[levelB] ?? 4);
        if (orderDiff !== 0) return orderDiff;
        // Within same level, sort by index
        return (a.index ?? 0) - (b.index ?? 0);
    });

    container.innerHTML = sortedPatterns.map(pattern => {
        const level = extractLevel(pattern.level || pattern.id);
        return `
            <div class="pattern-item" data-pattern-id="${escapeHtml(pattern.id)}">
                <span class="pattern-level ${level}">${level}</span>
                <span class="pattern-name">${escapeHtml(pattern.name || pattern.id)}</span>
                <span class="pattern-status">${pattern.name ? 'Named' : 'Unnamed'}</span>
            </div>
        `;
    }).join('');
}

function extractLevel(patternIdOrLevel) {
    const str = patternIdOrLevel.toLowerCase();
    if (str.includes('unified')) return 'unified';
    if (str.includes('top')) return 'top';
    if (str.includes('mid')) return 'mid';
    return 'bottom';
}

function updateNamingButtons() {
    const hasPatterns = state.patternData.length > 0;

    $('#btn-name-patterns').disabled = !hasPatterns && !state.projectId;
    $('#btn-population-viewer').disabled = !hasPatterns;

    // Enable naming if we have hierarchical weights (from SHAP analysis)
    if (state.projectId) {
        $('#btn-name-patterns').disabled = false;
    }
}

async function namePatterns() {
    const btn = $('#btn-name-patterns');
    btn.disabled = true;

    showStatus('naming-status-message', 'Starting pattern naming...', 'info');
    appendLog('naming', 'Starting LLM pattern naming...');

    $('#naming-progress').classList.remove('hidden');
    $('#naming-progress-bar').style.width = '0%';
    $('#naming-progress-percent').textContent = '0%';

    try {
        const response = await apiPost('/name-patterns');
        const jobId = response.job_id;

        showStatus('naming-status-message', 'Naming in progress...', 'info');

        // Poll for job status
        const pollInterval = setInterval(async () => {
            try {
                const job = await apiGet(`/jobs/${jobId}`);
                const pct = Math.round((job.progress || 0) * 100);

                $('#naming-progress-bar').style.width = `${pct}%`;
                $('#naming-progress-percent').textContent = `${pct}%`;
                $('#naming-progress-text').textContent = job.progress_message || 'Naming patterns...';

                if (job.status === 'completed') {
                    clearInterval(pollInterval);
                    showStatus('naming-status-message', 'Pattern naming complete!', 'success');
                    appendLog('naming', 'Pattern naming complete!');
                    $('#naming-progress').classList.add('hidden');
                    btn.disabled = false;
                    refreshPatternList();
                } else if (job.status === 'failed') {
                    clearInterval(pollInterval);
                    showStatus('naming-status-message', `Error: ${job.error}`, 'error');
                    appendLog('naming', `Error: ${job.error}`, 'error');
                    $('#naming-progress').classList.add('hidden');
                    btn.disabled = false;
                }
            } catch (pollError) {
                console.error('Failed to poll job status:', pollError);
            }
        }, 2000);

    } catch (error) {
        showStatus('naming-status-message', `Error: ${error.message}`, 'error');
        appendLog('naming', `Error: ${error.message}`, 'error');
        btn.disabled = false;
        $('#naming-progress').classList.add('hidden');
    }
}

function openPopulationViewer() {
    const url = state.projectId
        ? `population_viewer.html?project_id=${state.projectId}`
        : 'population_viewer.html';
    window.open(url, '_blank');
}

// ============================================================================
// Section 4: Individual Scoring
// ============================================================================
async function refreshScoringEngineers() {
    if (!state.projectId) return;

    const select = $('#scoring-engineer-select');

    try {
        const data = await apiGet('/data/engineers');
        const engineers = data.engineers || [];

        select.innerHTML = '<option value="">Select an engineer...</option>';
        engineers.forEach(eng => {
            const option = document.createElement('option');
            option.value = eng.engineer_id;
            option.textContent = eng.engineer_id;
            select.appendChild(option);
        });

        select.disabled = engineers.length === 0;

    } catch (error) {
        console.error('Failed to refresh scoring engineers:', error);
        select.innerHTML = '<option value="">No engineers available</option>';
        select.disabled = true;
    }
}

async function onScoringEngineerSelected(event) {
    state.selectedEngineerId = event.target.value;

    // Hide previous results
    $('#scores-card').style.display = 'none';
    $('#report-card').style.display = 'none';

    // Ensure R2 status is available for checkpoint check
    if (!state.r2Status || Object.keys(state.r2Status).length === 0) {
        await refreshR2Status();
    }

    updateScoringButtons();
}

async function updateScoringButtons() {
    if (!state.selectedEngineerId || !state.projectId) {
        $('#btn-score-engineer').disabled = true;
        $('#btn-generate-report').disabled = true;
        $('#btn-view-report').disabled = true;
        return;
    }

    // Check if checkpoint exists
    const hasCheckpoint = state.r2Status?.checkpoint?.exists;
    $('#btn-score-engineer').disabled = !hasCheckpoint;

    // Check if scores exist for this engineer
    try {
        const response = await fetch(`${getProjectApiBase()}/scoring/individual/${state.selectedEngineerId}`);
        const scoresExist = response.ok;

        $('#btn-generate-report').disabled = !scoresExist;

        // Check if report exists
        const reportResponse = await fetch(`${getProjectApiBase()}/scoring/report/${state.selectedEngineerId}`);
        const reportExists = reportResponse.ok;

        $('#btn-view-report').disabled = !reportExists;

    } catch (error) {
        $('#btn-generate-report').disabled = true;
        $('#btn-view-report').disabled = true;
    }
}

async function scoreEngineer() {
    if (!state.selectedEngineerId) return;

    const btn = $('#btn-score-engineer');
    btn.disabled = true;

    showStatus('scoring-status-message', 'Scoring engineer...', 'info');
    appendLog('scoring', `Scoring ${state.selectedEngineerId}...`);

    try {
        const job = await apiPost('/scoring/individual', {
            engineer_id: state.selectedEngineerId,
        });
        const jobId = job.id;

        appendLog('scoring', `Job started: ${jobId}`);

        // Poll for job completion
        const pollInterval = setInterval(async () => {
            try {
                const jobStatus = await apiGet(`/jobs/${jobId}`);

                if (jobStatus.status === 'completed') {
                    clearInterval(pollInterval);

                    // Fetch the actual scores
                    const scores = await apiGet(`/scoring/individual/${state.selectedEngineerId}`);
                    $('#scores-display').textContent = JSON.stringify(scores, null, 2);
                    $('#scores-card').style.display = 'block';

                    showStatus('scoring-status-message', 'Scoring complete!', 'success');
                    appendLog('scoring', 'Scoring complete', 'success');
                    btn.disabled = false;
                    await updateScoringButtons();
                } else if (jobStatus.status === 'failed') {
                    clearInterval(pollInterval);
                    showStatus('scoring-status-message', `Error: ${jobStatus.error}`, 'error');
                    appendLog('scoring', `Error: ${jobStatus.error}`, 'error');
                    btn.disabled = false;
                }
            } catch (pollError) {
                console.error('Failed to poll job status:', pollError);
            }
        }, 2000);

    } catch (error) {
        showStatus('scoring-status-message', `Error: ${error.message}`, 'error');
        appendLog('scoring', `Error: ${error.message}`, 'error');
        btn.disabled = false;
    }
}

async function generateReport() {
    if (!state.selectedEngineerId) return;

    const btn = $('#btn-generate-report');
    btn.disabled = true;

    showStatus('scoring-status-message', 'Generating report...', 'info');
    appendLog('scoring', `Generating report for ${state.selectedEngineerId}...`);

    try {
        const job = await apiPost(`/scoring/report/${state.selectedEngineerId}`);
        const jobId = job.id;

        appendLog('scoring', `Report job started: ${jobId}`);

        // Poll for job completion
        const pollInterval = setInterval(async () => {
            try {
                const jobStatus = await apiGet(`/jobs/${jobId}`);

                if (jobStatus.status === 'completed') {
                    clearInterval(pollInterval);

                    // Fetch the actual report
                    const report = await apiGet(`/scoring/report/${state.selectedEngineerId}`);
                    $('#report-display').innerHTML = report.report || report.content || JSON.stringify(report, null, 2);
                    $('#report-card').style.display = 'block';

                    showStatus('scoring-status-message', 'Report generated!', 'success');
                    appendLog('scoring', 'Report generated', 'success');
                    btn.disabled = false;
                    await updateScoringButtons();
                } else if (jobStatus.status === 'failed') {
                    clearInterval(pollInterval);
                    showStatus('scoring-status-message', `Error: ${jobStatus.error}`, 'error');
                    appendLog('scoring', `Error: ${jobStatus.error}`, 'error');
                    btn.disabled = false;
                }
            } catch (pollError) {
                console.error('Failed to poll job status:', pollError);
            }
        }, 2000);

    } catch (error) {
        showStatus('scoring-status-message', `Error: ${error.message}`, 'error');
        appendLog('scoring', `Error: ${error.message}`, 'error');
        btn.disabled = false;
    }
}

function viewFullReport() {
    if (!state.selectedEngineerId) return;

    const url = `report_viewer.html?engineer_id=${encodeURIComponent(state.selectedEngineerId)}&project_id=${state.projectId}`;
    window.open(url, '_blank');
}

function downloadScores() {
    const content = $('#scores-display').textContent;
    downloadJSON(content, `scores_${state.selectedEngineerId}.json`);
}

function downloadReport() {
    const content = $('#report-display').textContent;
    downloadText(content, `report_${state.selectedEngineerId}.md`);
}

function downloadJSON(content, filename) {
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadText(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// ============================================================================
// File Upload Handling
// ============================================================================
function setupFileUpload() {
    const uploadArea = $('#upload-area');
    const fileInput = $('#ndjson-file');
    const fileDisplay = $('#selected-file-display');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            showSelectedFile(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showSelectedFile(e.target.files[0]);
        }
    });
}

function showSelectedFile(file) {
    const fileDisplay = $('#selected-file-display');
    fileDisplay.textContent = `Selected: ${file.name} (${formatBytes(file.size)})`;
    fileDisplay.classList.remove('hidden');
}

// ============================================================================
// Event Listeners Setup
// ============================================================================
function setupEventListeners() {
    // Section tabs
    $$('.section-tab').forEach(tab => {
        tab.addEventListener('click', () => switchSection(tab.dataset.section));
    });

    // Project management
    $('#project-select').addEventListener('change', (e) => {
        const option = e.target.selectedOptions[0];
        selectProject(e.target.value, option?.dataset.name);
    });
    $('#btn-refresh-projects').addEventListener('click', loadProjects);
    $('#btn-create-project').addEventListener('click', createProject);
    $('#btn-delete-project').addEventListener('click', deleteProject);
    $('#btn-create-variant').addEventListener('click', showCreateVariantDialog);

    // Section 1: Data
    $('#btn-fetch-ndjson').addEventListener('click', fetchNDJSON);
    $('#btn-refresh-engineer-summary').addEventListener('click', refreshEngineerSummary);
    $('#btn-set-train').addEventListener('click', () => setEngineerSplit('train'));
    $('#btn-set-validation').addEventListener('click', () => setEngineerSplit('validation'));
    $('#btn-merge-engineers').addEventListener('click', mergeSelectedEngineers);
    $('#btn-remove-selected').addEventListener('click', removeSelectedEngineers);
    $('#select-all-engineers').addEventListener('change', (e) => {
        $$('.engineer-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateEngineerSelectionButtons();
    });
    $('#btn-clear-data-logs').addEventListener('click', () => clearLogs('data'));

    // Engineer checkbox changes
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('engineer-checkbox')) {
            updateEngineerSelectionButtons();
        }
    });

    // Engineer table column sorting
    $$('.engineer-table th[data-sort]').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const column = th.dataset.sort;
            if (engineerSortColumn === column) {
                engineerSortAsc = !engineerSortAsc;
            } else {
                engineerSortColumn = column;
                engineerSortAsc = true;
            }
            renderEngineerTable(state.engineerData);
        });
    });

    // Section 2: Processing
    $('#btn-refresh-r2-status').addEventListener('click', refreshR2Status);
    $('#btn-start-pipeline').addEventListener('click', startPipeline);
    $('#btn-clear-processing-logs').addEventListener('click', () => clearLogs('processing'));

    // Error banner buttons
    $('#btn-retry-pipeline').addEventListener('click', retryFromFailedStep);
    $('#btn-retry-full').addEventListener('click', retryFullPipeline);
    $('#btn-dismiss-error').addEventListener('click', hidePipelineError);

    // Starting point selection
    $$('.starting-point-option').forEach(option => {
        option.addEventListener('click', () => selectStartingPoint(option.dataset.step));
    });

    // Section 3: Naming
    $('#btn-name-patterns').addEventListener('click', namePatterns);
    $('#btn-refresh-patterns').addEventListener('click', refreshPatternList);
    $('#btn-population-viewer').addEventListener('click', openPopulationViewer);
    $('#btn-clear-naming-logs').addEventListener('click', () => clearLogs('naming'));

    // Section 4: Scoring
    $('#scoring-engineer-select').addEventListener('change', onScoringEngineerSelected);
    $('#btn-refresh-scoring-engineers').addEventListener('click', refreshScoringEngineers);
    $('#btn-score-engineer').addEventListener('click', scoreEngineer);
    $('#btn-generate-report').addEventListener('click', generateReport);
    $('#btn-view-report').addEventListener('click', viewFullReport);
    $('#btn-download-scores').addEventListener('click', downloadScores);
    $('#btn-download-report').addEventListener('click', downloadReport);
    $('#btn-clear-scoring-logs').addEventListener('click', () => clearLogs('scoring'));
}

// ============================================================================
// Initialization
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    setupFileUpload();
    setupEventListeners();
    loadProjects();

    // Initialize if project was previously selected
    if (state.projectId) {
        enableProjectUI();
        connectWebSocket();
        refreshCurrentSection();
    } else {
        disableProjectUI();
    }
});
    </script>
</body>
</html>
